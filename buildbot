#!/usr/bin/env python3

import sys
from pathlib import Path
from subprocess import run, PIPE
from contextlib import contextmanager

SHARED = Path(__file__).resolve().parent / 'shared'

def echo_run(cmd):
    print('+', *cmd)
    run(cmd)

@contextmanager
def instance():
    arch = run(['uname', '-m'], stdout=PIPE).stdout.decode('latin1').strip()
    vm = 'vm-{}'.format(arch).replace('_', '-')
    try:
        echo_run(['kitchen', 'create', vm])
        yield vm
    finally:
        echo_run(['kitchen', 'destroy', vm])

def run_buildbot(script):
    with instance() as vm:
        vm_script = Path('/mnt/shared') / script
        cmd = 'sudo {}'.format(str(vm_script))
        echo_run(['kitchen', 'exec', vm, '-c', cmd])

if __name__ == '__main__':
    import sys
    (script_txt,) = sys.argv[1:]
    run_buildbot(Path(script_txt).resolve().relative_to(SHARED))
